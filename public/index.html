<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>畢業學分自我檢視 — Web Viewer</title>
    <style>
        :root {
            --gap: 12px;
        }

        body {
            font-family: system-ui, -apple-system, "Noto Sans TC", Arial;
            margin: 24px;
        }

        .grid {
            display: grid;
            gap: var(--gap);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .toolbar {
            display: flex;
            gap: var(--gap);
            flex-wrap: wrap;
            align-items: center;
        }

        .card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 14px;
            background: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--gap);
        }

        .card h4 {
            margin: 0 0 6px;
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
        }

        .card .num {
            font-size: 20px;
            font-weight: 700;
        }

        .muted {
            color: #6b7280;
        }

        .table-wrap {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        thead th {
            position: sticky;
            top: 0;
            background: #f8fafc;
            z-index: 1;
            font-weight: 700;
        }

        th,
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
        }

        tr:hover td {
            background: #fafafa;
        }

        .pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #eef2ff;
            color: #3730a3;
            font-size: 12px;
        }

        .row-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        input[type="file"],
        select,
        input[type="search"],
        button {
            font: inherit;
        }

        button {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            background: #fff;
            cursor: pointer;
        }

        button:hover {
            background: #f3f4f6;
        }

        .spacer {
            flex: 1;
        }

        .tag {
            padding: 2px 6px;
            border-radius: 6px;
            background: #f1f5f9;
            font-size: 12px;
        }

        .right {
            text-align: right;
        }

        .nowrap {
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <div class="container grid" style="gap:20px;">


        <div class="toolbar">
            <form id="form" class="toolbar" onsubmit="return false;">
                <input type="file" name="htmlFile" accept=".html,.htm" required />
                <button id="btnParse">解析</button>
                <span class="spacer"></span>
                <!-- <a href="/upload.html" class="muted">回「產生器」頁</a> -->
            </form>
            <div class="toolbar" style="gap:10px;">
                <input id="stuName" placeholder="學生姓名" />
                <input id="stuYear" placeholder="學年度（例：113）" />
                <input id="stuSubmajor" placeholder="次領域（預設抓擇一）" />
                <button id="btnPrintView">開啟「列印版」</button>
            </div>
        </div>
        <div id="summary" class="cards"></div>


        <div class="toolbar">
            <input id="q" type="search" placeholder="搜尋 科目代碼/名稱/開課單位…" style="min-width:280px;" />
            <select id="filterCat"></select>
            <select id="filterDomain"></select>
            <label class="muted"><input type="checkbox" id="onlyNonPass" /> 只看未通過/0學分</label>
            <span id="count" class="muted"></span>
        </div>


        <div class="table-wrap">
            <table id="tbl">
                <thead>
                    <tr>
                        <th class="nowrap">類別</th>
                        <th class="nowrap">領域</th>
                        <th>科目</th>
                        <!-- <th class="nowrap">必/選</th> -->
                        <th class="nowrap">群</th>
                        <!-- <th>開課單位</th> -->
                        <th class="right nowrap">科目學分</th>
                        <th class="right nowrap">實得學分</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="infobox" style="display: block;">
            <h3>使用方式&須知：</h3>
            <li>由於新校務系統輸出的畢業學分審查與資管系的修業規則（次領域部分）有些不同，可以用這套系統看適用資管系的修業規則</li>
            <li>請先去新世代校務系統 <a href="https://sis.ncnu.edu.tw/">https://sis.ncnu.edu.tw/</a></li>
            <li>左方教務資訊/修業進度管制，按下查詢</li>
            <li>在頁面右鍵/另存新檔 or 在頁面 Crtl+S/Command+S 儲存整個網頁</li>
            <li>在左上角上傳你剛剛儲存的檔案，按下解析即可看到目前修課狀況</li>
            <li>按下開啟「列印版」即可輸出成「畢業學分學生自我檢核表」</li>
            <li>在開啟「列印版」還是先幫我先按下「解析」歐！</li>
            <img src="example.png" style="width: 100%;">
        </div>
    </div>


    <script>
        const $ = (s, el = document) => el.querySelector(s);
        const $$ = (s, el = document) => Array.from(el.querySelectorAll(s));


        let lastFile = null; // 保留上傳檔案供下載產出使用
        let raw = null; // 從 /parse 回來的 JSON
        let viewRows = []; // 經過篩選後的列

        // 工具：把連續相同值（且非空）切段，回傳 { span: Map(startIndex -> len), starts: Set(startIndex) }
        function computeRuns(arr) {
            const span = new Map();
            const starts = new Set();
            let runStart = null;
            const norm = v => (v == null ? '' : String(v).trim());
            for (let i = 0; i < arr.length; i++) {
                const v = norm(arr[i]);
                if (!v) { // 空值不合併
                    if (runStart !== null) { const len = i - runStart; if (len > 1) { span.set(runStart, len); } runStart = null; }
                    continue;
                }
                if (runStart === null) { runStart = i; }
                else {
                    const prev = norm(arr[i - 1]);
                    if (v !== prev) { const len = i - runStart; if (len > 1) { span.set(runStart, len); } runStart = i; }
                }
            }
            if (runStart !== null) { const len = arr.length - runStart; if (len > 1) { span.set(runStart, len); } }
            span.forEach((len, start) => starts.add(start));
            return { span, starts };
        }


        function renderSummary(d) {
            const c = $('#summary');
            if (!d || !d.ruleSummary) { c.innerHTML = ''; return; }
            const s = d.ruleSummary;
            const cards = [
                { name: '全校共同必修', val: s.byBucket.common, hint: `目標 ${s.requiredMin}` },
                { name: '通識領域課程', val: s.byBucket.general, hint: `目標 ${s.generalMin}` },
                { name: '院必修課程', val: s.byBucket.foundation },
                { name: '學系專業課程 ', val: s.byBucket.major },
                { name: '自由選修', val: s.byBucket.free }
            ];
            c.innerHTML = cards.map(x =>
                `<div class="card"><h4>${x.name}</h4><div class="num">${x.val ?? 0}</div><div class="muted">${x.hint || ''}</div></div>`
            ).join('');
            document.getElementById('infobox').style.display = "none";
        }


        function buildFilters(rows) {
            const selCat = $('#filterCat');
            const selDom = $('#filterDomain');
            const cats = Array.from(new Set(rows.map(r => r.category || '').filter(Boolean)));
            const doms = Array.from(new Set(rows.map(r => r.domain || '').filter(Boolean)));
            selCat.innerHTML = `<option value="">全部類別</option>` + cats.map(x => `<option>${x}</option>`).join('');
            selDom.innerHTML = `<option value="">全部領域</option>` + doms.map(x => `<option>${x}</option>`).join('');
        }


        function applyFilters() {
            if (!raw) return;
            const q = $('#q').value.trim().toLowerCase();
            const cat = $('#filterCat').value;
            const dom = $('#filterDomain').value;
            const onlyNP = $('#onlyNonPass').checked;
            viewRows = raw.data.filter(r => {
                if (cat && r.category !== cat) return false;
                if (dom && r.domain !== dom) return false;
                if (onlyNP) { const got = Number(r.earned_credits_course || 0); if (got > 0) return false; }
                if (q) {
                    const hay = [r.course?.code, r.course?.name, r.offered_by, r.group, r.req_type].join(' ').toLowerCase();
                    if (!hay.includes(q)) return false;
                }
                return true;
            });
            // === 只在「學系專業課程」內部做重排，避免系專業選修被分裂 ===
            const chosen = raw?.subdomainReassignment?.chosen || null;
            const isMajor = r => (r.category || '').trim() === '學系專業課程';
            const prio = r => {
                if (!isMajor(r)) return 0; // 非該類別不動排序
                const d = (r.domain || '').trim();
                if (d === '系必修') return 1;
                if (chosen && d === chosen) return 2; // 任一次領域（實際名稱為 chosen）
                if (d === '系專業選修') return 3;
                return 4; // 其他次領域或未分配
            };
            // 只重排屬於該類別的項目，維持其他列位置
            const idxs = [];
            const majors = [];
            viewRows.forEach((r, i) => { if (isMajor(r)) { idxs.push(i); majors.push(r); } });
            majors.sort((a, b) => {
                const pa = prio(a), pb = prio(b);
                if (pa !== pb) return pa - pb;
                return (a.rid ?? 0) - (b.rid ?? 0); // 同群以原始順序（rid）穩定排序
            });
            idxs.forEach((i, k) => { viewRows[i] = majors[k]; });

            renderTable(viewRows);
            $('#count').textContent = `顯示 ${viewRows.length} / 共 ${raw.data.length} 列`;
        }


        function renderTable(rows) {
            const tb = $('#tbl tbody');
            tb.innerHTML = '';
            if (!rows.length) return;


            // 計算 category / domain 的 run，用於 HTML 的 rowspan
            const catRuns = computeRuns(rows.map(r => r.category));
            // 讓被選中的次領域以「任一次領域」名義顯示，並與排序一致
            const chosen = raw?.subdomainReassignment?.chosen || null;
            const isMajorRow = r => (r.category || '').trim() === '學系專業課程';
            const domainLabels = rows.map(r => (isMajorRow(r) && chosen && (r.domain || '').trim() === chosen) ? '任一次領域' : (r.domain || ''));
            const domRuns = computeRuns(rows.map(r => r.domain));

            // === 針對「學系專業課程」：用 reassign 後的資料重新彙總各領域的 earned/required ===
            const domainAgg = (() => {
                const map = new Map();
                const all = raw?.data || [];
                const chosenAll = raw?.subdomainReassignment?.chosen || null;
                const alias = chosenAll ? '任一次領域' : null;
                const threshold = raw?.subdomainReassignment?.threshold ?? 24;
                const isMajorAll = rr => (rr.category || '').trim() === '學系專業課程';
                all.forEach(rr => {
                    if (!isMajorAll(rr)) return;
                    let label = (rr.domain || '').trim();
                    if (alias && label === chosenAll) label = alias; // 被選中的次領域 → 任一次領域
                    const got = Number(rr.earned_credits_course ?? 0);
                    const cur = map.get(label) || { earned: 0, required: null };
                    cur.earned += Number.isFinite(got) ? got : 0;
                    if (label === alias) {
                        cur.required = threshold; // 任一次領域固定門檻
                    } else if (cur.required == null && rr.required_credits_group != null) {
                        cur.required = rr.required_credits_group; // 取第一個出現的須修學分
                    }
                    map.set(label, cur);
                });
                return map;
            })();

            rows.forEach((r, i) => {
                const tr = document.createElement('tr');


                // 類別（直向合併 + 顯示 earned/required）
                const catLine = (() => {
                    const sum = (raw && raw.summary) ? raw.summary[r.category] : null;
                    if (sum && sum.earned != null && sum.required != null) {
                        return `<div class="muted" style="font-size:12px;margin-top:4px;">${sum.earned} / ${sum.required}</div>`;
                    }
                    return '';
                })();


                if (catRuns.starts.has(i)) {
                    const td = document.createElement('td');
                    td.innerHTML = (r.category || '') + catLine;
                    const span = catRuns.span.get(i);
                    if (span) td.rowSpan = span;
                    tr.appendChild(td);
                } else if (!(rows[i - 1] && rows[i - 1].category === r.category && (r.category || '').trim() !== '')) {
                    // 前一列不同或空，仍需補一格
                    const td = document.createElement('td');
                    td.innerHTML = (r.category || '') + catLine;
                    tr.appendChild(td);
                }

                // 領域（直向合併 + 顯示 earned/required + 門檻提示）
                const domText = (isMajorRow(r) && chosen && (r.domain || '').trim() === chosen)
                    ? `任一次領域<span class="muted">（${chosen}）</span>`
                    : (r.domain || '');

                // 以彙總後的 domainAgg（全資料集）為主；非學系專業課程則退回單列數值
                let need = null, got = null;
                const labelKey = domainLabels[i];
                if (isMajorRow(r) && domainAgg.has(labelKey)) {
                    const agg = domainAgg.get(labelKey);
                    need = agg.required;
                    got = agg.earned;
                } else {
                    // fallback 單列
                    need = (Number.isFinite(r.required_credits_group) ? r.required_credits_group : (typeof r.required_credits_group === 'number' ? r.required_credits_group : null));
                    got = (Number.isFinite(r.earned_credits_group) ? r.earned_credits_group : (typeof r.earned_credits_group === 'number' ? r.earned_credits_group : null));
                }

                const domLine = (() => {
                    let html = '';
                    if (need != null || got != null) {
                        html += `<div class="muted" style="font-size:12px;margin-top:4px;">${(got ?? '')} / ${(need ?? '')}</div>`;
                        if (need != null && got != null) {
                            const ok = Number(got) >= Number(need);
                            html += `<div style="font-size:12px;margin-top:2px; color:${ok ? '#16a34a' : '#dc2626'}">${ok ? '已達規定門檻' : '未達規定門檻'}</div>`;
                        }
                    }
                    return html;
                })();

                if (domRuns.starts.has(i)) {
                    const td = document.createElement('td');
                    td.innerHTML = (r.domain || '') + domLine;
                    const span = domRuns.span.get(i);
                    if (span) td.rowSpan = span;
                    tr.appendChild(td);
                } else if (!(rows[i - 1] && rows[i - 1].domain === r.domain && (r.domain || '').trim() !== '')) {
                    const td = document.createElement('td');
                    td.innerHTML = (r.domain || '') + domLine;
                    tr.appendChild(td);
                }


                // 科目
                const tdCourse = document.createElement('td');
                tdCourse.innerHTML = `<div><strong>${r.course?.code ?? ''}</strong> ${r.course?.name ?? ''}</div>`;
                // 顯示歷次紀錄小標籤
                if (Array.isArray(r.course?.records) && r.course.records.length) {
                    const tags = r.course.records.map(rec => `<span class="tag">${rec.term || ''} ${rec.credits ?? ''}</span>`).join(' ');
                    tdCourse.insertAdjacentHTML('beforeend', `<div class="muted" style="margin-top:4px;">${tags}</div>`);
                }
                tr.appendChild(tdCourse);


                const mk = (txt) => { const td = document.createElement('td'); td.textContent = txt || ''; return td; };
                // tr.appendChild(mk(r.req_type));
                tr.appendChild(mk(r.group));
                // tr.appendChild(mk(r.offered_by));


                const tdC = mk(r.course_credits != null ? r.course_credits : ''); tdC.className = 'right'; tr.appendChild(tdC);
                const tdE = mk(r.earned_credits_course != '' ? r.earned_credits_course : '0'); tdE.className = 'right'; tr.appendChild(tdE);


                tb.appendChild(tr);
            });
            localStorage.setItem("courseRows", JSON.stringify(rows));
        }


        async function doParse(fd) {
            const r = await fetch('/parse', { method: 'POST', body: fd });
            const j = await r.json();
            raw = j;
            const studentName = j?.meta?.studentInfo?.studentName || '';
            const studentId = j?.meta?.studentInfo?.studentId || '';
            document.getElementById('stuName').value = studentName;
            document.getElementById('stuYear').value = studentId.substring(0, 3);
            renderSummary(j);
            buildFilters(j.data || []);
            applyFilters();
        }


        // 事件
        $('#btnParse').addEventListener('click', async () => {
            const form = $('#form');
            const fd = new FormData(form);
            lastFile = fd.get('htmlFile');
            if (!lastFile) { alert('請選擇檔案'); return; }
            await doParse(fd);
        });

        // 列印版引導：把目前解析結果 + 使用者輸入存到 localStorage 再跳頁
        $('#btnPrintView').addEventListener('click', () => {
            if (!raw) { alert('請先解析一份課程 HTML'); return; }
            const payload = {
                raw,
                name: $('#stuName').value.trim() || '',
                semester: $('#stuYear').value.trim() || '',
                submajor: $('#stuSubmajor').value.trim() || (raw?.subdomainReassignment?.chosen || '')
            };
            try { localStorage.setItem('print_payload', JSON.stringify(payload)); } catch { }
            location.href = '/print.html';
        });


        $('#q').addEventListener('input', applyFilters);
        $('#filterCat').addEventListener('change', applyFilters);
        $('#filterDomain').addEventListener('change', applyFilters);
        $('#onlyNonPass').addEventListener('change', applyFilters);
    </script>
</body>

</html>