<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>畢業學分學生自我檢核表 — 列印版</title>
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    table {
      border-collapse: collapse;
      border: solid 5px;
      border-color: #46488e;
      width: 95%;
      font-size: 16px;
    }

    td,
    th {
      border: 2px solid #808080;
      padding: 8px;
      text-align: center;
    }

    tr.drop-target {
      background-color: #f0f8ff;
    }

    #red_txt {
      color: #FF0000;
    }
  </style>
</head>

<body>
  <h2 style="text-align: center;">國立暨南國際大學 資訊管理學系<br>畢業學分學生自我檢核表</h2>

  <table id="metaTbl">
    <thead>
      <tr>
        <th style="padding:2px;">姓名</th>
        <th style="padding:2px;" id="m_name"></th>
        <th style="padding:2px;">學年</th>
        <th style="padding:2px;" id="m_sem"></th>
        <th style="padding:2px;">次領域</th>
        <th style="padding:2px;" id="m_sub" colspan="2"></th>
        <th style="padding:2px;" colspan="2">目前已修習學分數</th>
        <th style="padding:2px;" id="m_earned"></th>
      </tr>
      <tr>
        <th colspan="10">
          <div class="small">
            <span id="m_desc"></span>
          </div>
        </th>
      </tr>
    </thead>
  </table>

  <table id="listTbl" style="border-top: none;">
    <thead></thead>
    <tbody></tbody>
  </table>

  <script>
    const $ = (s, el = document) => el.querySelector(s);
    const $$ = (s, el = document) => Array.from(el.querySelectorAll(s));
    const currentYear = 1141;

    function loadPayload() {
      try { return JSON.parse(localStorage.getItem('print_payload') || '{}'); } catch { return {}; }
    }

    function computeChosen(raw) { return maxSubdomain = Object.keys(raw.subdomainReassignment.totals).reduce((a, b) => (raw.subdomainReassignment.totals[a] > raw.subdomainReassignment.totals[b] ? a : b)) || ''; }

    function buildMeta(payload) {
      const raw = payload.raw || {};
      $('#m_name').textContent = payload.name || '';
      $('#m_sem').textContent = payload.semester || '';

      const chosen = payload.submajor || computeChosen(raw) || '';
      $('#m_sub').textContent = chosen || '資訊技術與系統開發次領域';

      // 目前已修習學分數：用 ruleSummary.graduation 或回退加總
      const earnedTotal = raw?.ruleSummary?.graduation?.earned ?? (raw?.data || []).reduce((a, r) => {
        const e = Number(r.earned_credits_course ?? 0); return a + (Number.isFinite(e) ? e : 0);
      }, 0);
      $('#m_earned').textContent = earnedTotal;

      const sum = raw.summary || {};
      const totalReq = sum?.graduation_total?.required ?? raw?.ruleSummary?.graduation?.required ?? '';

      // 各桶 required（依校方摘要鍵名）
      const getRequired = (k) => sum?.[k]?.required ?? '';
      // const getEarned = (k) => sum?.[k]?.earned ?? '';
      const line = `本表 ${payload.semester || ''} 學年度入學之學生適用。 最低畢業門檻:${totalReq} 學分,分別為以下：<br>
        <span style=\"color:#0000FF\">全校共同課程:</span>${getRequired('全校共同課程')}，
        <span style=\"color:#0000FF\">通識領域課程:</span>${getRequired('通識領域課程')}，
        <span style=\"color:#0000FF\">院必修:</span>${getRequired('基礎院本課程')}，
        <span style=\"color:#0000FF\">系必修:</span>${(raw?.data || []).find(r => r.category === '學系專業課程' && r.domain === '系必修')?.required_credits_group || ''}，
        <span style=\"color:#0000FF\">次領域+系專業選修:</span>${(function () {
          const majors = (raw?.data || []).filter(r => r.category === '學系專業課程');
          const one = majors.find(r => r.domain === '資訊技術與系統開發次領域')?.required_credits_group || '';
          const sel = majors.find(r => r.domain === '系專業選修')?.required_credits_group || '';
          return one + "+" + sel;
        })()}，
        <span style=\"color:#0000FF\">自由選修:</span>${getRequired('自由選修')}`;
      $('#m_desc').innerHTML = line;
    }

    function appendRow(tbody, cells) {
      const tr = document.createElement('tr');
      cells.forEach(c => {
        const td = document.createElement(c.header ? 'th' : 'td');
        if (c.colspan) td.colSpan = c.colspan;
        if (c.rowspan) td.rowSpan = c.rowspan;
        td.style.padding = '2px';
        td.innerHTML = c.html ?? (c.text ?? '');
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }

    function buildBody(payload) {
      const raw = payload.raw || {};
      const rows = raw.data || [];
      const sum = raw.summary || {};
      const tbody = $('#listTbl tbody');
      tbody.innerHTML = '';

      const catOrder = ['全校共同課程', '通識領域課程', '基礎院本課程', '學系專業課程', '自由選修'];
      const getRequired = (k) => sum?.[k]?.required ?? '';
      const getEarned = (k) => sum?.[k]?.earned ?? '';

      catOrder.forEach(cat => {
        const items = rows.filter(r => (r.category || '').trim() === cat);
        if (!items.length) return;

        if (cat === '全校共同課程' || cat === '基礎院本課程' || cat === '自由選修') {
          // 類別 + 每列一個科目名稱
          appendRow(tbody, [
            { text: cat + "<br>" + (getEarned(cat) + "/" + getRequired(cat)) + "<br>" + (getEarned(cat) >= getRequired(cat) ? "已達規定門檻" : "<span style=\"color:#FF0000\">未達規定門檻</span>"), rowspan: Math.max(2, items.length), colspan: 2, header: true },
            { text: `<span style="color:${items[0]?.course_raw_text?.includes(currentYear) ? '#B94FFF' : '#000'}">${items[0]?.course?.name ?? ''}${items[0]?.course_raw_text?.includes(currentYear) ? ` (${items[0]?.course_credits ?? ''})` : " " + items[0]?.earned_credits_course + " 學分"}</span>`, colspan: 8 }
          ]);
          for (let i = 1; i < items.length; i++) {
            appendRow(tbody, [{ text: `<span style="color:${items[i]?.course_raw_text?.includes(currentYear) ? '#B94FFF' : '#000'}">${items[i]?.course?.name ?? ''}${items[i]?.course_raw_text?.includes(currentYear) ? ` (${items[i]?.course_credits ?? ''})` : " " + items[i]?.earned_credits_course + " 學分"}</span>`, colspan: 8 }]);
          }
          if (items.length === 1) {
            appendRow(tbody, [{ text: '...', colspan: 8 }]);
          }
        } else if (cat === '通識領域課程') {
          // 依 domain 分組，列出 group 與課名
          const byDom = new Map();
          items.forEach(r => {
            const d = (r.domain || '').trim();
            const arr = byDom.get(d) || []; arr.push(r); byDom.set(d, arr);
          });
          let firstInCat = true;
          byDom.forEach((arr, dom) => {
            // 每個 domain 至少兩列；顯示 group 與課名
            const spanDomain = Math.max(2, arr.length);
            if (firstInCat) {
              appendRow(tbody, [
                { text: cat + "<br><br>" + (getEarned(cat) >= getRequired(cat) ? "已達規定門檻" : "<span style=\"color:#FF0000\">未達規定門檻</span>"), rowspan: Math.max(2, items.length), colspan: 2, header: true },
                { text: dom + "<br>" + (arr[0]?.earned_credits_group + "/" + arr[0]?.required_credits_group), rowspan: spanDomain, colspan: 2, header: true },
                { text: arr[0]?.group || '', colspan: 3 },
                { text: `<span style="color:${arr[0]?.course_raw_text?.includes(currentYear) ? '#B94FFF' : '#000'}">${arr[0]?.course?.name ?? ''}${arr[0]?.course_raw_text?.includes(currentYear) ? ` (${arr[0]?.course_credits ?? ''})` : " " + arr[0]?.earned_credits_course + " 學分"}</span>`, colspan: 3 }
              ]);
              firstInCat = false;
            } else {
              appendRow(tbody, [
                { text: dom + "<br>" + (arr[0]?.earned_credits_group + "/" + arr[0]?.required_credits_group), rowspan: spanDomain, colspan: 2, header: true },
                { text: arr[0]?.group || '', colspan: 3 },
                { text: `<span style="color:${arr[0]?.course_raw_text?.includes(currentYear) ? '#B94FFF' : '#000'}">${arr[0]?.course?.name ?? ''}${arr[0]?.course_raw_text?.includes(currentYear) ? ` (${arr[0]?.course_credits ?? ''})` : " " + arr[0]?.earned_credits_course + " 學分"}</span>`, colspan: 3 }
              ]);
            }
            for (let i = 1; i < arr.length; i++) {
              appendRow(tbody, [
                { text: arr[i]?.group || '', colspan: 3 },
                { text: `<span style="color:${arr[i]?.course_raw_text?.includes(currentYear) ? '#B94FFF' : '#000'}">${arr[i]?.course?.name ?? ''}${arr[i]?.course_raw_text?.includes(currentYear) ? ` (${arr[i]?.course_credits ?? ''})` : " " + arr[i]?.earned_credits_course + " 學分"}</span>`, colspan: 3 }
              ]);
            }
            if (arr.length < 2) {
              appendRow(tbody, [
                { text: arr[0]?.group || '', colspan: 3 },
                { text: '...', colspan: 3 }
              ]);
            }
          });
        } else if (cat === '學系專業課程') {
          // 使用 parser 的 reassign 結果：將被選中的次領域顯示為「任一次領域」
          const chosen = computeChosen(raw);
          const alias = chosen ? '任一次領域' : null;
          const threshold = raw?.subdomainReassignment?.threshold ?? 24;

          // 對每列加上顯示用的 label（被選中的次領域 → 任一次領域）
          const itemsRe = items.map(r => {
            const d = (r.domain || '').trim();
            const label = (alias && d === chosen) ? alias : d;
            return { ...r, __label: label };
          });

          // 彙總各領域 earned/required（以 reassign 後的 label）
          const domainAgg = new Map();
          itemsRe.forEach(rr => {
            const key = rr.__label;
            const got = Number(rr.earned_credits_course ?? 0);
            const cur = domainAgg.get(key) || { earned: 0, required: null, realName: null };
            cur.earned += Number.isFinite(got) ? got : 0;
            if (key === alias) {
              cur.required = threshold;         // 任一次領域固定門檻
              cur.realName = chosen;            // 記下實際次領域名稱
            } else if (cur.required == null && rr.required_credits_group != null) {
              cur.required = rr.required_credits_group; // 其他領域取第一筆的須修學分
            }
            domainAgg.set(key, cur);
          });

          // 排序：系必修 → 任一次領域 → 系專業選修 → 其他（同群以 rid 保持穩定）
          const pr = r => {
            const label = r.__label;
            if (label === '系必修') return 1;
            if (alias && label === alias) return 2;
            if (label === '系專業選修') return 3;
            return 4;
          };
          const sorted = itemsRe.slice().sort((a, b) => pr(a) - pr(b) || (a.rid - b.rid));

          // 依 label 分組，輸出：類別(2col) + 領域(2col, rowspan) + 課名(6col)
          const byDom = new Map();
          sorted.forEach(r => {
            const key = r.__label;
            const arr = byDom.get(key) || [];
            arr.push(r);
            byDom.set(key, arr);
          });

          let t = 0;

          const newItems = byDom.forEach((arr, label) => {
            t += Math.max(3, arr.length);
          });

          let firstInCat = true;
          byDom.forEach((arr, label) => {
            const spanDomain = Math.max(3, arr.length); // 最少 3 行以符合模板視覺
            const agg = domainAgg.get(label) || { earned: 0, required: null, realName: null };
            const domName = (label === alias && agg.realName)
              ? `${agg.realName}`
              : label;
            const domHeaderHtml = `${domName == chosen ? `<span style="color:#0000FF">${domName}</span>` : domName}<br>${agg.earned} / ${agg.required ?? ''}`;
            const matchScore = agg.earned >= agg.required;

            if (firstInCat) {
              appendRow(tbody, [
                { text: cat, rowspan: Math.max(3, t), colspan: 2, header: true },
                { html: domHeaderHtml + "<br>" + (matchScore ? "已達規定門檻" : "<span style=\"color:#FF0000\">未達規定門檻</span>"), rowspan: spanDomain, colspan: 2, header: true },
                { text: `<span style="color:${arr[0]?.course_raw_text?.includes(currentYear) ? '#B94FFF' : '#000'}">${arr[0]?.course?.name ?? " " + arr[0]?.earned_credits_course + " 學分"}${arr[0]?.course_raw_text?.includes(currentYear) ? ` (${arr[0]?.course_credits ?? ''})` : " " + arr[0]?.earned_credits_course + " 學分"}</span>`, colspan: 6 }
              ]);
              firstInCat = false;
            } else {
              appendRow(tbody, [
                { html: domHeaderHtml + "<br>" + (matchScore ? "已達規定門檻" : "<span style=\"color:#FF0000\">未達規定門檻</span>"), rowspan: spanDomain, colspan: 2, header: true },
                { text: `<span style="color:${arr[0]?.course_raw_text?.includes(currentYear) ? '#B94FFF' : '#000'}">${arr[0]?.course?.name ?? " " + arr[0]?.earned_credits_course + " 學分"}${arr[0]?.course_raw_text?.includes(currentYear) ? ` (${arr[0]?.course_credits ?? ''})` : " " + arr[0]?.earned_credits_course + " 學分"}</span>`, colspan: 6 }
              ]);
            }

            for (let i = 1; i < arr.length; i++) {
              appendRow(tbody, [
                { text: `<span style="color:${arr[i]?.course_raw_text?.includes(currentYear) ? '#B94FFF' : '#000'}">${arr[i]?.course?.name ?? " " + arr[i]?.earned_credits_course + " 學分"}${arr[i]?.course_raw_text?.includes(currentYear) ? ` (${arr[i]?.course_credits ?? ''})` : " " + arr[i]?.earned_credits_course + " 學分"}</span>`, colspan: 6 }
              ]);
            }
            if (arr.length < 3) {
              for (let k = arr.length; k < 3; k++) {
                appendRow(tbody, [{ text: '...', colspan: 6 }]);
              }
            }
          });
        }
      });

      date = new Date();
      year = date.getFullYear();
      month = date.getMonth() + 1;
      day = date.getDate();

      appendRow(tbody, [{ text: "<br><br>通識講座<br><br>", colspan: 2 }, { text: sum.lecture, colspan: 8 }]);
      appendRow(tbody, [{ text: "<br><br>英文畢業門檻<br><br>", colspan: 2 }, { text: sum.english, colspan: 8 }]);
      appendRow(tbody, [{ text: "<br><br>備註<br>(供手動認抵學分用)<br><br>", colspan: 2 }, { text: "<br><br><br><br>務必請授課老師親簽或蓋章,代表同意抵免課程,以利系辦複核", colspan: 8 }]);
      appendRow(tbody, [{ text: "學號：" + raw.meta.studentInfo.studentId + "<br>學生簽名<br>" + month + "/" + day + "/" + year, colspan: 2 }, { text: "<br><br><br>本人經查核,確認畢業學分無誤。", colspan: 3 }, { text: "系辦複核:", colspan: 2 }, { text: "", colspan: 3 }]);
    }

    (function init() {
      const payload = loadPayload();
      if (!payload || !payload.raw) {
        alert('找不到解析資料，請先到檢視頁載入。');
        location.href = '/viewer.html';
        return;
      }
      buildMeta(payload);
      buildBody(payload);
    })();
  </script>
</body>

</html>